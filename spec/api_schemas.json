{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kpi.local/api-schemas.json",
  "title": "KPI API Schemas",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
    },
    "date": {
      "type": "string",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
    },
    "timestamptz": {
      "type": "string",
      "format": "date-time"
    },
    "currency": {
      "type": "string",
      "pattern": "^[A-Z]{3}$"
    },
    "kpi_code": {
      "type": "string",
      "pattern": "^KPI[0-9]{2}_[A-Z0-9_]+$"
    },
    "DataQualityFlags": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "excluded_for_data_quality": { "type": "boolean" },
        "excused_delay": { "type": "boolean" },
        "cancellation_flag": { "type": "boolean" },
        "partial_delivery_flag": { "type": "boolean" }
      }
    },

    "DepartmentCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 2, "maxLength": 200 },
        "active": { "type": "boolean" }
      },
      "examples": [
        { "name": "Automation", "active": true }
      ]
    },

    "PersonCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["full_name"],
      "properties": {
        "full_name": { "type": "string", "minLength": 2, "maxLength": 200 },
        "department_id": { "$ref": "#/$defs/uuid" },
        "title": { "type": "string", "maxLength": 200 },
        "active": { "type": "boolean" }
      },
      "examples": [
        {
          "full_name": "Bahadir Atilgan",
          "department_id": "11111111-1111-1111-1111-111111111111",
          "title": "Automation Project Manager",
          "active": true
        }
      ]
    },

    "ProjectCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_code"],
      "properties": {
        "project_code": { "type": "string", "minLength": 2, "maxLength": 50 },
        "project_name": { "type": "string", "maxLength": 200 },
        "owner_person_id": { "$ref": "#/$defs/uuid" },
        "department_id": { "$ref": "#/$defs/uuid" },
        "start_date": { "$ref": "#/$defs/date" },
        "end_date": { "$ref": "#/$defs/date" }
      },
      "examples": [
        {
          "project_code": "AUTO-2026-001",
          "project_name": "Demo Automation Project",
          "owner_person_id": "22222222-2222-2222-2222-222222222222",
          "department_id": "11111111-1111-1111-1111-111111111111",
          "start_date": "2026-01-01",
          "end_date": "2026-01-31"
        }
      ]
    },

    "RoleCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["role_name", "hourly_rate", "currency", "effective_from"],
      "properties": {
        "role_name": { "type": "string", "minLength": 2, "maxLength": 200 },
        "hourly_rate": { "type": "number", "minimum": 0 },
        "currency": { "$ref": "#/$defs/currency" },
        "effective_from": { "$ref": "#/$defs/date" },
        "effective_to": { "$ref": "#/$defs/date" }
      },
      "examples": [
        {
          "role_name": "Automation Engineer",
          "hourly_rate": 250,
          "currency": "TRY",
          "effective_from": "2025-01-01"
        }
      ]
    },

    "ProjectFinancialCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "period_start", "period_end", "revenue", "direct_costs", "currency"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "revenue": { "type": "number", "minimum": 0 },
        "direct_costs": { "type": "number", "minimum": 0 },
        "currency": { "$ref": "#/$defs/currency" },
        "invoice_total": { "type": "number", "minimum": 0 },
        "notes": { "type": "string", "maxLength": 2000 },
        "data_quality_flags": { "$ref": "#/$defs/DataQualityFlags" }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "revenue": 1000000,
          "direct_costs": 700000,
          "currency": "TRY",
          "invoice_total": 1000000
        }
      ]
    },

    "ProjectInnovationCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "period_start", "period_end", "innovation_flag_manual"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "innovation_flag_manual": { "type": "boolean" },
        "innovation_description": { "type": "string", "maxLength": 2000 },
        "innovation_tags": { "type": "array", "items": { "type": "string", "maxLength": 50 } },
        "notes": { "type": "string", "maxLength": 2000 },
        "data_quality_flags": { "$ref": "#/$defs/DataQualityFlags" }
      },
      "allOf": [
        {
          "if": {
            "properties": { "innovation_flag_manual": { "const": true } },
            "required": ["innovation_flag_manual"]
          },
          "then": { "required": ["innovation_description"] }
        }
      ],
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "innovation_flag_manual": true,
          "innovation_description": "AI vision inspection for defect detection",
          "innovation_tags": ["AI", "Vision"]
        }
      ]
    },

    "InnovationScoreUpdate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "period_start", "period_end", "innovation_score", "innovation_score_status"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "innovation_score": { "type": "number", "minimum": 0, "maximum": 100 },
        "innovation_score_reason": { "type": "string", "maxLength": 2000 },
        "innovation_score_model": { "type": "string", "maxLength": 100 },
        "innovation_score_status": { "type": "string", "enum": ["scored", "failed"] },
        "innovation_scored_at": { "$ref": "#/$defs/timestamptz" }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "innovation_score": 80,
          "innovation_score_reason": "Clear AI usage in production workflow",
          "innovation_score_model": "gpt-4o-mini",
          "innovation_score_status": "scored",
          "innovation_scored_at": "2026-02-01T10:00:00Z"
        }
      ]
    },

    "ProjectDeliveryCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "effective_committed_date"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "effective_committed_date": { "$ref": "#/$defs/timestamptz" },
        "final_delivery_date": { "$ref": "#/$defs/timestamptz" },
        "delivered_scope_fully_accepted": { "type": "boolean" },
        "delivery_status": { "type": "string", "enum": ["DELIVERED", "IN_PROGRESS", "CANCELLED", "ON_HOLD"] },
        "excused_delay": { "type": "boolean" },
        "cancellation_flag": { "type": "boolean" },
        "partial_delivery_flag": { "type": "boolean" },
        "documentation_complete_flag": { "type": "boolean" },
        "training_complete_flag": { "type": "boolean" },
        "punch_list_open_items_count": { "type": "integer", "minimum": 0 },
        "excluded_for_data_quality": { "type": "boolean" },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "effective_committed_date": "2026-01-20T00:00:00Z",
          "final_delivery_date": "2026-01-18T00:00:00Z",
          "delivered_scope_fully_accepted": true,
          "delivery_status": "DELIVERED",
          "excused_delay": false,
          "cancellation_flag": false,
          "partial_delivery_flag": false,
          "documentation_complete_flag": true,
          "training_complete_flag": true,
          "punch_list_open_items_count": 0,
          "excluded_for_data_quality": false
        }
      ]
    },

    "AuditRecordCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["audit_type", "audit_date"],
      "properties": {
        "audit_type": { "type": "string", "enum": ["ISG", "ISO", "OTHER"] },
        "iso_standard": { "type": "string", "maxLength": 50 },
        "audit_date": { "$ref": "#/$defs/date" },
        "audit_score": { "type": "number", "minimum": 0, "maximum": 100 },
        "nonconformity_count": { "type": "integer", "minimum": 0 },
        "closed_on_time_count": { "type": "integer", "minimum": 0 },
        "critical_findings_count": { "type": "integer", "minimum": 0 },
        "scope": { "type": "string", "maxLength": 200 },
        "department_id": { "$ref": "#/$defs/uuid" },
        "notes": { "type": "string", "maxLength": 2000 },
        "data_quality_flags": { "$ref": "#/$defs/DataQualityFlags" }
      },
      "examples": [
        {
          "audit_type": "ISO",
          "iso_standard": "ISO9001",
          "audit_date": "2026-01-12",
          "audit_score": 88,
          "nonconformity_count": 5,
          "closed_on_time_count": 4,
          "critical_findings_count": 0,
          "scope": "Automation dept",
          "department_id": "11111111-1111-1111-1111-111111111111"
        }
      ]
    },

    "ReworkEntryCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "role_id", "work_date", "rework_hours"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "person_id": { "$ref": "#/$defs/uuid" },
        "role_id": { "$ref": "#/$defs/uuid" },
        "work_date": { "$ref": "#/$defs/date" },
        "rework_hours": { "type": "number", "exclusiveMinimum": 0 },
        "rework_reason": { "type": "string", "maxLength": 500 },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "person_id": "22222222-2222-2222-2222-222222222222",
          "role_id": "44444444-4444-4444-4444-444444444444",
          "work_date": "2026-01-15",
          "rework_hours": 10,
          "rework_reason": "Wiring changes after review"
        }
      ]
    },

    "StandardizationScoreCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "period_start", "period_end", "standardization_score"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "standardization_score": { "type": "number", "minimum": 0, "maximum": 100 },
        "code_review_coverage": { "type": "number", "minimum": 0, "maximum": 100 },
        "ci_pass_rate": { "type": "number", "minimum": 0, "maximum": 100 },
        "standard_libs_usage": { "type": "number", "minimum": 0, "maximum": 100 },
        "lint_rule_compliance": { "type": "number", "minimum": 0, "maximum": 100 },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "standardization_score": 85,
          "code_review_coverage": 90,
          "ci_pass_rate": 95,
          "standard_libs_usage": 80,
          "lint_rule_compliance": 88
        }
      ]
    },

    "TrainingRecordCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["person_id", "training_course", "training_completed_date", "hours"],
      "properties": {
        "person_id": { "$ref": "#/$defs/uuid" },
        "training_course": { "type": "string", "minLength": 2, "maxLength": 200 },
        "training_completed_date": { "$ref": "#/$defs/date" },
        "hours": { "type": "number", "minimum": 0 },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "person_id": "22222222-2222-2222-2222-222222222222",
          "training_course": "PLC Advanced",
          "training_completed_date": "2026-01-22",
          "hours": 8
        }
      ]
    },

    "HeadcountSnapshotCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["department_id", "snapshot_date", "headcount"],
      "properties": {
        "department_id": { "$ref": "#/$defs/uuid" },
        "snapshot_date": { "$ref": "#/$defs/date" },
        "headcount": { "type": "integer", "minimum": 0 },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "department_id": "11111111-1111-1111-1111-111111111111",
          "snapshot_date": "2026-01-31",
          "headcount": 10
        }
      ]
    },

    "ProjectTechnologyCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "tech_tag", "implementation_date"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "tech_tag": { "type": "string", "minLength": 2, "maxLength": 50 },
        "implementation_date": { "$ref": "#/$defs/date" },
        "status": { "type": "string", "enum": ["POC", "PILOT", "PROD", "RETIRED"] },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "tech_tag": "AI",
          "implementation_date": "2026-01-15",
          "status": "PROD",
          "notes": "Vision inspection"
        }
      ]
    },

    "ProjectTestCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "test_type", "attempt_no", "result", "test_date"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "test_type": { "type": "string", "enum": ["FAT", "SAT"] },
        "attempt_no": { "type": "integer", "minimum": 1 },
        "result": { "type": "string", "enum": ["PASS", "FAIL", "CANCELLED"] },
        "test_date": { "$ref": "#/$defs/date" },
        "first_pass_flag": { "type": "boolean" },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "test_type": "FAT",
          "attempt_no": 1,
          "result": "PASS",
          "test_date": "2026-01-18",
          "first_pass_flag": true
        }
      ]
    },

    "ProjectCostEstimateCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "estimate_date", "estimated_cost", "currency"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "estimate_date": { "$ref": "#/$defs/date" },
        "estimated_cost": { "type": "number", "minimum": 0 },
        "currency": { "$ref": "#/$defs/currency" },
        "estimate_version": { "type": "string", "maxLength": 50 },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "estimate_date": "2025-12-20",
          "estimated_cost": 900000,
          "currency": "TRY",
          "estimate_version": "v1"
        }
      ]
    },

    "ProjectCostActualCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "period_start", "period_end", "actual_cost", "currency"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "actual_cost": { "type": "number", "minimum": 0 },
        "currency": { "$ref": "#/$defs/currency" },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "actual_cost": 880000,
          "currency": "TRY"
        }
      ]
    },

    "SkillAssessmentCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["person_id", "assessment_date", "assessment_type", "assessment_cycle_id", "skill_score"],
      "properties": {
        "person_id": { "$ref": "#/$defs/uuid" },
        "assessment_date": { "$ref": "#/$defs/date" },
        "assessment_type": { "type": "string", "enum": ["baseline", "current"] },
        "assessment_cycle_id": { "$ref": "#/$defs/uuid" },
        "skill_domain": { "type": "string", "maxLength": 100 },
        "skill_score": { "type": "number", "minimum": 0, "maximum": 100 },
        "evaluator_id": { "$ref": "#/$defs/uuid" },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "person_id": "22222222-2222-2222-2222-222222222222",
          "assessment_date": "2026-01-25",
          "assessment_type": "current",
          "assessment_cycle_id": "55555555-5555-5555-5555-555555555555",
          "skill_domain": "automation",
          "skill_score": 78,
          "evaluator_id": "22222222-2222-2222-2222-222222222222"
        }
      ]
    },

    "CsatSurveyCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "survey_date", "score_raw"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "survey_date": { "$ref": "#/$defs/date" },
        "score_raw": { "type": "number", "minimum": 0, "maximum": 5 },
        "scale_max": { "type": "number", "minimum": 1, "maximum": 10 },
        "respondent_type": { "type": "string", "maxLength": 50 },
        "comment": { "type": "string", "maxLength": 2000 },
        "notes": { "type": "string", "maxLength": 2000 },
        "data_quality_flags": { "$ref": "#/$defs/DataQualityFlags" }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "survey_date": "2026-01-22",
          "score_raw": 4,
          "scale_max": 5,
          "respondent_type": "end_user",
          "comment": "Delivery met expectations"
        }
      ]
    },

    "EngagementSurveyCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["department_id", "survey_date", "score_raw"],
      "properties": {
        "department_id": { "$ref": "#/$defs/uuid" },
        "survey_cycle_id": { "$ref": "#/$defs/uuid" },
        "survey_date": { "$ref": "#/$defs/date" },
        "score_raw": { "type": "number", "minimum": 0, "maximum": 5 },
        "scale_max": { "type": "number", "minimum": 1, "maximum": 10 },
        "response_count": { "type": "integer", "minimum": 1 },
        "person_id": { "$ref": "#/$defs/uuid" },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "department_id": "11111111-1111-1111-1111-111111111111",
          "survey_cycle_id": "66666666-6666-6666-6666-666666666666",
          "survey_date": "2026-01-31",
          "score_raw": 4.1,
          "scale_max": 5,
          "response_count": 10
        }
      ]
    },

    "ProjectRiskCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "identified_date", "safety_related", "initial_score"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "risk_code": { "type": "string", "maxLength": 50 },
        "identified_date": { "$ref": "#/$defs/date" },
        "last_review_date": { "$ref": "#/$defs/date" },
        "safety_related": { "type": "boolean" },
        "initial_score": { "type": "integer", "minimum": 1, "maximum": 25 },
        "current_score": { "type": "integer", "minimum": 0, "maximum": 25 },
        "status": { "type": "string", "enum": ["OPEN", "MITIGATED", "CLOSED"] },
        "mitigation_actions": { "type": "string", "maxLength": 2000 },
        "notes": { "type": "string", "maxLength": 2000 },
        "data_quality_flags": { "$ref": "#/$defs/DataQualityFlags" }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "risk_code": "RISK-001",
          "identified_date": "2026-01-05",
          "last_review_date": "2026-01-25",
          "safety_related": true,
          "initial_score": 20,
          "current_score": 12,
          "status": "MITIGATED",
          "mitigation_actions": "Add safety interlock and training"
        }
      ]
    },

    "InnovationRoiCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "period_start", "period_end", "investment_cost", "currency"],
      "properties": {
        "project_id": { "$ref": "#/$defs/uuid" },
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "investment_cost": { "type": "number", "minimum": 0 },
        "incremental_revenue": { "type": "number", "minimum": 0 },
        "cost_savings": { "type": "number", "minimum": 0 },
        "incremental_costs": { "type": "number", "minimum": 0 },
        "currency": { "$ref": "#/$defs/currency" },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "examples": [
        {
          "project_id": "33333333-3333-3333-3333-333333333333",
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "investment_cost": 200000,
          "incremental_revenue": 400000,
          "cost_savings": 50000,
          "incremental_costs": 50000,
          "currency": "TRY"
        }
      ]
    },

    "KpiComputeRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["period_start", "period_end"],
      "properties": {
        "period_start": { "$ref": "#/$defs/date" },
        "period_end": { "$ref": "#/$defs/date" },
        "owner_person_id": { "$ref": "#/$defs/uuid" },
        "department_id": { "$ref": "#/$defs/uuid" },
        "kpi_codes": {
          "type": "array",
          "items": { "$ref": "#/$defs/kpi_code" }
        },
        "force_recompute": { "type": "boolean" }
      },
      "examples": [
        {
          "period_start": "2026-01-01",
          "period_end": "2026-01-31",
          "owner_person_id": "22222222-2222-2222-2222-222222222222",
          "kpi_codes": ["KPI01_PROFIT_MARGIN", "KPI02_INNOVATION_SHARE"]
        }
      ]
    }
  }
}
